package frc.robot.commands;

import static edu.wpi.first.units.Units.Meters;

import edu.wpi.first.units.measure.Distance;
import edu.wpi.first.wpilibj2.command.Command;
import frc.robot.Constants.ShootingConstants;
import frc.robot.subsystems.FeederSubsystem;
import frc.robot.subsystems.ShooterSubsystem;
import frc.robot.subsystems.ShooterSubsystem.ShooterSetpoints;
import frc.robot.subsystems.SpindexerSubsystem;

/*
 * Command to shoot fuel without aiming. It will shoot at a fixed yaw, pitch, and velocity
 */
public class ShootCommand extends Command {
  private final SpindexerSubsystem spindexerSubsystem;
  private final FeederSubsystem feederSubsystem;
  private final ShooterSubsystem shooterSubsystem;
  private final ShooterSetpoints setpoints;
  private boolean isShooting = false;

  /**
   * Constructor for ShootCommand
   * 
   * @param spindexerSubsystem the spindexer subsystem
   * @param feederSubsystem the feeder subsystem
   * @param shooterSubsystem the shooter subsystem
   * @param targetDistance the distance of the target to use for setpoints
   */
  public ShootCommand(
      SpindexerSubsystem spindexerSubsystem,
      FeederSubsystem feederSubsystem,
      ShooterSubsystem shooterSubsystem,
      Distance targetDistance) {
    this.feederSubsystem = feederSubsystem;
    this.spindexerSubsystem = spindexerSubsystem;
    this.shooterSubsystem = shooterSubsystem;

    setpoints = ShootingConstants.SHOOTER_TARGETS_BY_DISTANCE_METERS.get(targetDistance.in(Meters));

    addRequirements(feederSubsystem, spindexerSubsystem, shooterSubsystem);
  }

  @Override
  public void initialize() {
    isShooting = false;
  }

  @Override
  public void execute() {
    /*
     * sets the Yaw, Pitch, and Angle
     */
    // shooterSubsystem.setYawAngle(Constants.ShooterConstants.YAW_HOME_ANGLE);
    shooterSubsystem.setPitchAngle(setpoints.targetPitch());
    shooterSubsystem.setFlywheelSpeed(setpoints.targetFlywheelSpeed());
    /*
     * Checks to make sure the shooter is ready and up to speed
     * before runnig the spindexer and feeder
     */
    if (isShooting || shooterSubsystem.isPitchAtSetpoint() && shooterSubsystem.isFlywheelAtSpeed()) {
      isShooting = true;
      spindexerSubsystem.runSpindexer(setpoints.spindexerVelocity());
      feederSubsystem.runFeeder(setpoints.feederVelocity());
    }
  }

  public void end(boolean interrupted) {
    spindexerSubsystem.stop();
    feederSubsystem.stop();
    shooterSubsystem.stopAll();
  }
}
